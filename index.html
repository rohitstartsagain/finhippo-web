<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FinHippo â€” Login</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:680px;margin:40px auto;padding:0 16px}
    h1{font-size:22px;margin-bottom:12px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
    input,button{padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;margin:6px 0;width:100%}
    button{cursor:pointer}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    #app{display:none}
    .muted{color:#6b7280;font-size:12px}
  </style>
</head>
<body>
  <h1>FinHippo â€” Sign in</h1>

  <!-- AUTH CARD -->
  <div class="card" id="auth-card">
    <div class="row">
      <input id="email" type="email" placeholder="email@example.com" />
      <input id="password" type="password" placeholder="password" />
    </div>
    <div class="row">
      <button id="btn-sign-in">Sign in</button>
      <button id="btn-sign-up">Sign up</button>
    </div>
    <div class="muted">Use the two user accounts you created in Supabase.</div>
    <div id="auth-msg" class="muted"></div>
  </div>

 <!-- APP CARD (visible after login) -->
<div class="card" id="app">
  <div id="hello"></div>

  <div id="chat" style="margin-top:12px">
    <div id="messages" style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;min-height:140px;max-height:260px;overflow:auto;margin-bottom:8px"></div>
    <div class="row">
      <input id="chat-input" placeholder="Type a message e.g. I spent Rs 800 on lunch yesterday" />
      <button id="chat-send">Send</button>
    </div>
  </div>

  <button id="btn-sign-out" style="margin-top:8px">Sign out</button>
</div>


  <!-- Supabase + our script -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // â¬‡ï¸  Paste your own Supabase URL and ANON KEY between the quotes
    const SUPABASE_URL = "https://rextklbyxobvstkyegyt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJleHRrbGJ5eG9idnN0a3llZ3l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjQ4ODQsImV4cCI6MjA3MjY0MDg4NH0.G4HKlLZSdKn1GLwLcpkAYkMCY9dfXz1DP1ZkTDKxtko";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const emailEl = document.querySelector("#email");
    const passwordEl = document.querySelector("#password");
    const msgEl = document.querySelector("#auth-msg");
    const authCard = document.querySelector("#auth-card");
    const appCard = document.querySelector("#app");
    const helloEl = document.querySelector("#hello");

    function showLoggedIn(user){
      authCard.style.display = "none";
      appCard.style.display = "block";
      helloEl.textContent = `Hello, ${user.email}`;
    }
    function showLoggedOut(){
      authCard.style.display = "block";
      appCard.style.display = "none";
      helloEl.textContent = "";
    }

    // handle existing session on load
    (async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) showLoggedIn(user); else showLoggedOut();
    })();

    // listen for auth changes
    supabase.auth.onAuthStateChange((_event, session) => {
      if (session?.user) showLoggedIn(session.user); else showLoggedOut();
    });

    // buttons
    document.querySelector("#btn-sign-in").addEventListener("click", async () => {
      msgEl.textContent = "Signing inâ€¦";
      const { error } = await supabase.auth.signInWithPassword({
        email: emailEl.value.trim(),
        password: passwordEl.value
      });
      msgEl.textContent = error ? `Error: ${error.message}` : "";
    });

    document.querySelector("#btn-sign-up").addEventListener("click", async () => {
      msgEl.textContent = "Creating accountâ€¦";
      const { error } = await supabase.auth.signUp({
        email: emailEl.value.trim(),
        password: passwordEl.value
      });
      msgEl.textContent = error ? `Error: ${error.message}` : "Check email for confirmation (if enabled). Try sign in.";
    });

    document.querySelector("#btn-sign-out").addEventListener("click", async () => {
      await supabase.auth.signOut();
      showLoggedOut();
    });
const messagesEl = document.querySelector("#messages");
const chatInputEl = document.querySelector("#chat-input");
const chatSendBtn = document.querySelector("#chat-send");

function addMsg(role, text){
  const div = document.createElement("div");
  div.style.margin = "6px 0";
  div.innerHTML = `<strong>${role}:</strong> ${text}`;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function sendToAgent(text) {
  // get current user identity to bind Letta memory
  const { data: { user } } = await supabase.auth.getUser();
  const identifier = user?.email || user?.id || "unknown";

  addMsg("You", text);
  chatInputEl.value = "";
  chatInputEl.disabled = true;
  chatSendBtn.disabled = true;

  try {
    const res = await fetch("/.netlify/functions/letta-chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, identifier })
    });

    let data;
    try {
      data = await res.json();
    } catch {
      const txt = await res.text();
      addMsg("Agent", `âš ï¸ Server error ${res.status}: ${txt.slice(0,160)}â€¦`);
      return;
    }

    if (data.error) {
      addMsg("Agent", `âš ï¸ ${data.error}`);
    } else {
      addMsg("Agent", data.reply);

      // ðŸ§ª check for confirmed JSON
      let j = extractConfirmedJson(data);
      if (!j && text.trim().toLowerCase() === "yes") {
        // invisible nudge
        const nudge = await fetch("/.netlify/functions/letta-chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: "Now output one fenced ```json block``` exactly as specified and nothing else.",
            identifier
          })
        });
        const nudgeData = await nudge.json();
        j = extractConfirmedJson(nudgeData);
        if (j) {
          addMsg("Agent", "ðŸ“¦ (Got JSON on second try)");
        } else {
          addMsg("Agent", "ðŸ§ª (Still no confirmed JSON found)");
        }
      }

      if (j && j.status && j.status.toLowerCase() === "confirmed") {
        try {
          await saveExpenseFromConfirmedJson(j);
          addMsg("Agent", "ðŸ’¾ Saved to database.");
        } catch (e) {
          addMsg("Agent", `âš ï¸ Could not save to DB: ${e.message}`);
        }
      }
    }
  } catch (e) {
    addMsg("Agent", `âš ï¸ ${e.message}`);
  } finally {
    chatInputEl.disabled = false;
    chatSendBtn.disabled = false;
    chatInputEl.focus();
  }
}



chatSendBtn.addEventListener("click", () => {
  const t = chatInputEl.value.trim();
  if (t) sendToAgent(t);
});
chatInputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") chatSendBtn.click();
});

// --- JSON extraction + DB save helpers ---

function extractConfirmedJson(apiResult) {
  // 1) Look for a Letta code element (some workspaces return this)
  try {
    const els = apiResult?.raw?.message?.content?.elements;
    if (Array.isArray(els)) {
      const codeEl = els.find(e =>
        (e.type === "code" || e.kind === "code") &&
        /json/i.test(e.language || e.lang || "")
      );
      const codeText = codeEl?.text || codeEl?.content;
      if (codeText) return JSON.parse(codeText);
    }
  } catch (_) {}

  // 2) Fenced code block in the text reply
  try {
    const t = apiResult?.reply || "";
    const m = t.match(/```json\s*([\s\S]*?)```/i) || t.match(/```\s*([\s\S]*?)```/i);
    if (m) return JSON.parse(m[1]);
  } catch (_) {}

  return null;
}

function normalizeDateToISO(d) {
  // Accept "YYYY-MM-DD" or "DD-MM-YYYY"
  if (/^\d{2}-\d{2}-\d{4}$/.test(d)) {
    const [dd, mm, yyyy] = d.split("-");
    return `${yyyy}-${mm}-${dd}`;
  }
  return d;
}

async function getHouseholdIdFor(userId) {
  // MVP: try membership; fall back to 'home-001'
  try {
    const { data, error } = await supabase
      .from("household_members")
      .select("household_id")
      .eq("user_id", userId)
      .single();
    if (error) throw error;
    return data?.household_id || "home-001";
  } catch {
    return "home-001";
  }
}

async function saveExpenseFromConfirmedJson(j) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("No session");

  const household_id = await getHouseholdIdFor(user.id);

  const payload = {
    household_id,
    user_id: user.id,
    user_email: user.email,
    date: normalizeDateToISO(j.date),
    amount: Number(j.amount),
    currency: j.currency || "INR",
    category: j.category || "Miscellaneous",
    description: j.description || null,
    source: j.source || "text"
  };

  const { error } = await supabase.from("expenses").insert(payload);
  if (error) throw error;
}

  </script>
</body>
</html>





